# Do's and Don'ts
- OpenAPI client auto-regenerates on code changes when dev servers are running - don't manually regenerate.
- Prefer running apx related commands via MCP server if it's available.
- Use the apx MCP `search_registry_components` and `add_component` tools to find and add shadcn/ui components.
- When using the API calls on the frontend, use error boundaries to handle errors.
- Run `apx dev check` command (via CLI or MCP) to check for errors in the project code after making changes.
- If agent has access to native browser tool, use it to verify changes on the frontend. If such tool is not present or is not working, use playwright MCP to automate browser actions (e.g. screenshots, clicks, etc.).
- **Databricks SDK:** Use the apx MCP `docs` tool to search Databricks SDK documentation instead of guessing or hallucinating API signatures.

## Package Management
- **Frontend:** Bun might not be present on user's $PATH. It's recommended to use prebundled bun (e.g., `uv run apx bun install` or `uv run apx bun add <dependency>`), unless user explicitly stated otherwise.
- **Python:** Always use `uv` (never `pip`)

## Component Management
- **Finding components:** Use MCP `search_registry_components` to search for available shadcn/ui components
- **Adding components:** Use MCP `add_component` or CLI `uv run apx components add <component> --yes` to add components
- **Component location:** If component was added to a wrong location (e.g. stored into `src/components` instead of `src/sobeys-scctower/ui/components`), move it to the proper folder
- **Component organization:** Prefer grouping components by functionality rather than by file type (e.g. `src/sobeys-scctower/ui/components/chat/`)

## Project Structure
Full-stack app: `src/sobeys-scctower/ui/` (React + Vite) and `src/sobeys-scctower/backend/` (FastAPI). Backend serves frontend at `/` and API at `/api`. API client auto-generated from OpenAPI schema.

## Dependencies & Dependency Injection

The `Dependency` class in `src/sobeys-scctower/backend/core.py` provides typed FastAPI dependencies. **Always use these instead of manually creating clients or accessing `request.app.state`.**

| Dependency | Type | Description |
|---|---|---|
| `Dependency.Client` | `WorkspaceClient` | Databricks client using app-level service principal credentials |
| `Dependency.UserClient` | `WorkspaceClient` | Databricks client authenticated on behalf of the current user (requires OBO token) |
| `Dependency.Config` | `AppConfig` | Application configuration loaded from environment variables |
| `Dependency.Session` | `Session` | SQLModel database session, scoped to request (stateful apps only) |

**Usage in route handlers:**
```python
from .core import Dependency, create_router

router = create_router()

@router.get("/clusters", response_model=list[ClusterOut], operation_id="listClusters")
def list_clusters(ws: Dependency.Client):
    return ws.clusters.list()

@router.get("/me", response_model=UserOut, operation_id="currentUser")
def me(user_ws: Dependency.UserClient):
    return user_ws.current_user.me()

@router.get("/settings", response_model=AppSettingsOut, operation_id="getSettings")
def get_settings(config: Dependency.Config):
    return AppSettingsOut(app_name=config.app_name)
```

**Extending `AppConfig`** — add custom fields to `AppConfig` in `core.py`; they are populated from env vars with `{APP_SLUG}_` prefix:
```python
class AppConfig(BaseSettings):
    app_name: str = Field(default=app_name)
    my_setting: str = Field(default="value")  # env var: {APP_SLUG}_MY_SETTING
```

**Custom lifespan** — use the `lifespan` parameter in `create_app` for startup/shutdown logic (default lifespan with config + workspace client runs first):
```python
@asynccontextmanager
async def custom_lifespan(app: FastAPI):
    # app.state.config and app.state.workspace_client already available
    app.state.my_resource = await init_something(app.state.config)
    yield

app = create_app(routers=[router], lifespan=custom_lifespan)
```

## Models & API
- **3-model pattern:** `Entity` (DB), `EntityIn` (input), `EntityOut` (output)
- **API routes must have:** `response_model` and `operation_id` for client generation

## Frontend Rules
- **Routing:** `@tanstack/react-router` (routes in `src/sobeys-scctower/ui/routes/`)
- **Data fetching:** Always use `useXSuspense` hooks with `Suspense` and `Skeleton` components
- **Pattern:** Render static elements immediately, fetch API data with suspense
- **Components:** Use shadcn/ui, add to `src/sobeys-scctower/ui/components/`
- **Data access:** Use `selector()` function for clean destructuring (e.g., `const {data: profile} = useProfileSuspense(selector())`)

## Development Commands

**Start dev servers** (backend, frontend, OpenAPI watcher):
```bash
uv run apx dev start
```

**Check status** (shows running servers and ports):
```bash
uv run apx dev status
```

**Check for errors** (TypeScript, Python linting):
```bash
uv run apx dev check
```

**View logs:**
```bash
uv run apx dev logs              # Recent logs (default: last 10m)
uv run apx dev logs -d 1h        # Logs from last hour
uv run apx dev logs -f           # Follow/stream logs live
```

**Stop servers:**
```bash
uv run apx dev stop
```

**Build for production:**
```bash
uv run apx build
```

**Note:** OpenAPI client is automatically regenerated on every code change when dev servers are running. No manual regeneration needed.

## MCP Tools Reference

When the apx MCP server is available, use these tools:

| Tool | Description |
|------|-------------|
| `start` | Start development server and return the URL |
| `stop` | Stop the development server |
| `restart` | Restart the development server (preserves port if possible) |
| `logs` | Fetch recent dev server logs |
| `check` | Check project code for errors (runs tsc and ty checks in parallel) |
| `refresh_openapi` | Regenerate OpenAPI schema and API client |
| `search_registry_components` | Search shadcn registry components using semantic search |
| `add_component` | Add a component to the project |
| `docs` | Search Databricks SDK documentation for code examples and API references |
| `databricks_apps_logs` | Fetch logs from deployed Databricks app using Databricks CLI |
| `get_route_info` | Get code example for using a specific API route |
